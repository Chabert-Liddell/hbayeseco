<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="hbm4ecology">
<title>Hierarchical Stock Recruitment Analysis • hbm4ecology</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Hierarchical Stock Recruitment Analysis">
<meta property="og:description" content="hbm4ecology">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">hbm4ecology</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/hierarchical-exchangeable-cmr.html">Hierarchical Exchangeable Binomial Model for Capture-Mark-Recapture Data</a>
    <a class="dropdown-item" href="../articles/hierarchical-stock-recruitment.html">Hierarchical Stock Recruitment Analysis</a>
    <a class="dropdown-item" href="../articles/hierarchical-successive-removal.html">Hierarchical Successive Removal</a>
    <a class="dropdown-item" href="../articles/namibian-hake-biomass-production.html">Biomass Production Model: The Namibian Hake Fishery</a>
    <a class="dropdown-item" href="../articles/state-space-modeling-of-a-salmon-life-cycle-model.html">State-space Modeling of A. Salmon Life Cycle Model</a>
    <a class="dropdown-item" href="../articles/stan-jags-performance-comparaison-for-hbmforecology.html">Stan and Jags performance comparaison for Hierarchical Bayesian Modeling for Ecological Data</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Hierarchical Stock Recruitment Analysis</h1>
            <h3 data-toc-skip class="subtitle">Stan program for
Hierarchical Stock-recruitment analysis (with covariates Latitude)
Chapter 9 - section 9.3</h3>
            
      
      
      <div class="d-none name"><code>hierarchical-stock-recruitment.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">hbm4ecology</span><span class="op">)</span></span>
<span><span class="co">#&gt; Please visit the site https://Chabert-Liddell.github.io/hbm4ecology/articles/</span></span>
<span><span class="co">#&gt;                           for R case study.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan/" class="external-link">rstan</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: StanHeaders</span></span>
<span><span class="co">#&gt; Loading required package: ggplot2</span></span>
<span><span class="co">#&gt; rstan (Version 2.21.5, GitRev: 2e1f913d3ca3)</span></span>
<span><span class="co">#&gt; For execution on a local, multicore CPU with excess RAM we recommend calling</span></span>
<span><span class="co">#&gt; options(mc.cores = parallel::detectCores()).</span></span>
<span><span class="co">#&gt; To avoid recompilation of unchanged Stan programs, we recommend calling</span></span>
<span><span class="co">#&gt; rstan_options(auto_write = TRUE)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/posterior/" class="external-link">posterior</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; This is posterior version 1.2.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'posterior'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:rstan':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     ess_bulk, ess_tail</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     mad, sd, var</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Attaching packages</span> ─────────────────────────────────────── tidyverse 1.3.1 ──</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tibble </span> 3.1.7     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">dplyr  </span> 1.0.9</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tidyr  </span> 1.2.0     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">stringr</span> 1.4.0</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">readr  </span> 2.1.2     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">forcats</span> 0.5.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">purrr  </span> 0.3.4</span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Conflicts</span> ────────────────────────────────────────── tidyverse_conflicts() ──</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">tidyr</span>::<span style="color: #00BB00;">extract()</span> masks <span style="color: #0000BB;">rstan</span>::extract()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">filter()</span>  masks <span style="color: #0000BB;">stats</span>::filter()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">lag()</span>     masks <span style="color: #0000BB;">stats</span>::lag()</span></span>
<span><span class="co">#plot_theme &lt;- theme_set(theme_classic(base_size = 15L))</span></span>
<span><span class="va">plot_theme</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15L</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span><span class="op">)</span>,</span>
<span>        strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#4da598"</span><span class="op">)</span>,</span>
<span>        strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This article develops a hierarchical extension of the Ricker Stock
Recruitment model. The data and models are based on a published paper by
Pr{'{e}}vost et al. <span class="citation">Prévost et al. (<a href="#ref-Prevost2003" role="doc-biblioref">2003</a>)</span>; but see
also <span class="citation">Prévost, Chaput, and (Ed.) (<a href="#ref-PrevostChaput2001" role="doc-biblioref">2001</a>)</span>.</p>
<p>We show that the hierarchical assemblage of several salmon
populations which we model as exchangeable units appears as the working
solution to transfer information and borrow strength from data-rich to
data-poor situations. The data structure is sophisticated with Normal
latent vectors, and the probabilistic structures have to be designed
conditionally on some available covariates, namely the latitude and the
riverine wetted area accessible to salmon.</p>
<div class="section level3">
<h3 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"SRSalmon"</span><span class="op">)</span></span></code></pre></div>
<p>The analysis of stock and recruitment (SR) relationships is the most
widely used approach for deriving <em>Biological Reference Points</em>
in fisheries sciences. It is particularly well suited for anadromous
salmonid species for which the recruitment of juveniles in freshwater is
more easily measured than the recruitment of marine species. SR
relationships are critical for setting reference points for the
management of salmon populations, such as the spawning target <span class="math inline">\(S^{\ast}\)</span>, a biological reference point
for the number of spawners which are necessary to guarantee an optimal
sustainable exploitation, or the maximum sustainable exploitation rate
<span class="math inline">\(h^{\ast}\)</span>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  River <span class="op">=</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">name_riv</span>,</span>
<span>  Country <span class="op">=</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">country_riv</span>,</span>
<span>  Latitude <span class="op">=</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">lat</span>,</span>
<span>  `Area accessible to salmon` <span class="op">=</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">area</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">River</th>
<th align="left">Country</th>
<th align="right">Latitude</th>
<th align="right">Area accessible to salmon</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Nivelle</td>
<td align="left">France</td>
<td align="right">43.50000</td>
<td align="right">320995</td>
</tr>
<tr class="even">
<td align="left">Oir</td>
<td align="left">France</td>
<td align="right">48.50000</td>
<td align="right">48000</td>
</tr>
<tr class="odd">
<td align="left">Frome</td>
<td align="left">England</td>
<td align="right">50.50000</td>
<td align="right">876420</td>
</tr>
<tr class="even">
<td align="left">Dee</td>
<td align="left">England</td>
<td align="right">53.00000</td>
<td align="right">6170000</td>
</tr>
<tr class="odd">
<td align="left">Burrishoole</td>
<td align="left">Ireland</td>
<td align="right">53.98515</td>
<td align="right">155000</td>
</tr>
<tr class="even">
<td align="left">Lune</td>
<td align="left">England</td>
<td align="right">54.50000</td>
<td align="right">4230000</td>
</tr>
<tr class="odd">
<td align="left">Bush</td>
<td align="left">N. Ireland</td>
<td align="right">55.00000</td>
<td align="right">845500</td>
</tr>
<tr class="even">
<td align="left">Mourne</td>
<td align="left">N. Ireland</td>
<td align="right">55.00000</td>
<td align="right">10360560</td>
</tr>
<tr class="odd">
<td align="left">Faughan</td>
<td align="left">N. Ireland</td>
<td align="right">55.00000</td>
<td align="right">882380</td>
</tr>
<tr class="even">
<td align="left">Girnock Burn</td>
<td align="left">Scotland</td>
<td align="right">57.00000</td>
<td align="right">58764</td>
</tr>
<tr class="odd">
<td align="left">North Esk</td>
<td align="left">Scotland</td>
<td align="right">57.00000</td>
<td align="right">2100000</td>
</tr>
<tr class="even">
<td align="left">Laerdalselva</td>
<td align="left">Norway</td>
<td align="right">61.00000</td>
<td align="right">704000</td>
</tr>
<tr class="odd">
<td align="left">Ellidaar</td>
<td align="left">Iceland</td>
<td align="right">64.00000</td>
<td align="right">199711</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tib</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>Obs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">SRSalmon</span><span class="op">$</span><span class="va">n</span><span class="op">)</span>,</span>
<span>              River <span class="op">=</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">riv</span>,</span>
<span>              Stock <span class="op">=</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">S</span>,</span>
<span>              Recruitment <span class="op">=</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">R</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">tib</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">tib</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">Obs</th>
<th align="right">River</th>
<th align="right">Stock</th>
<th align="right">Recruitment</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0.957</td>
<td align="right">2.647</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">1</td>
<td align="right">0.501</td>
<td align="right">0.444</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">1</td>
<td align="right">2.286</td>
<td align="right">1.801</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">1</td>
<td align="right">1.481</td>
<td align="right">0.573</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">1</td>
<td align="right">1.596</td>
<td align="right">0.356</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="right">1</td>
<td align="right">2.679</td>
<td align="right">0.390</td>
</tr>
<tr class="odd">
<td align="right">134</td>
<td align="right">13</td>
<td align="right">37.955</td>
<td align="right">111.579</td>
</tr>
<tr class="even">
<td align="right">135</td>
<td align="right">13</td>
<td align="right">42.157</td>
<td align="right">139.799</td>
</tr>
<tr class="odd">
<td align="right">136</td>
<td align="right">13</td>
<td align="right">32.309</td>
<td align="right">124.208</td>
</tr>
<tr class="even">
<td align="right">137</td>
<td align="right">13</td>
<td align="right">34.869</td>
<td align="right">85.049</td>
</tr>
<tr class="odd">
<td align="right">138</td>
<td align="right">13</td>
<td align="right">24.022</td>
<td align="right">73.261</td>
</tr>
<tr class="even">
<td align="right">139</td>
<td align="right">13</td>
<td align="right">31.268</td>
<td align="right">71.534</td>
</tr>
</tbody>
</table>
<center>
<div class="figure">
<img src="figures/SRSalmon/Map_13rivers.png" style="width:70.0%;height:70.0%" alt=""><p class="caption">Location of the 13 index rivers with available
stock-recruitment datasets for A. salmon (from <span class="citation">Prévost et al. (<a href="#ref-Prevost2003" role="doc-biblioref">2003</a>)</span>).</p>
</div>
</center>
<p>There are several hundreds of salmon stocks in the northeast Atlantic
area, each having its own characteristics with regard to the size and
productivity of the salmon populations. But resources to collect SR data
are limited and suitable SR series (both in terms of length and
reliability of observations) such as the ones of <code>SRSalmon</code>
are only available for a handful of monitored rivers spread throughout
the European area of distribution of the species. These so-called
<em>index rivers</em> are a representative sample from the salmon rivers
located in western Europe and under the influence of the Gulf Stream.
This sample covers a broad area including Spain, France, UK, Ireland,
Norway, the western coast of Sweden and the southwestern coast of
Iceland. The collection and pre-processing procedures used to obtain the
data ready for SR analysis presented in Table
<!-- \ref{tab5x6:13rivers} and Fig. \ref{Fig5x6:FittedSR_13rivers} -->
are described in detail in <span class="citation">Crozier et al. (<a href="#ref-Crozier2003" role="doc-biblioref">2003</a>)</span> or <span class="citation">Prévost et al. (<a href="#ref-Prevost2003" role="doc-biblioref">2003</a>)</span>. Here, hierarchical modeling will
be used to address two questions:</p>
<ul>
<li>How is the SR information transferred from the monitored data-rich
rivers to set Biological Reference Points for other sparse-data salmon
rivers, while accounting for the major sources of uncertainty?</li>
<li>How can the joint analysis of the SR relationship for the 13 index
rivers be used to forecast biological reference points for a new river
without any SR data but for which relevant covariates are
available?</li>
</ul>
</div>
<div class="section level2">
<h2 id="model-without-covariates">Model without covariates<a class="anchor" aria-label="anchor" href="#model-without-covariates"></a>
</h2>
<p>Ricker model with lognormal errors and management related
parametrization</p>
<ul>
<li><span class="math inline">\(\log(R_{k,t}) = h_{k}^{*} +
\log(\frac{S_{k,t}}{1-h^{*}{t}}) - \frac{h^{*}_{k}}{S^{*}_{k}}S_{k,t} +
\epsilon_{k,t}\)</span></li>
<li><span class="math inline">\(\epsilon_{k,t} \overset{iid}{\sim}
Normal(0, \sigma_k^2)\)</span></li>
</ul>
<div class="section level4">
<h4 id="defining-priors-for-the-model">Defining priors for the model<a class="anchor" aria-label="anchor" href="#defining-priors-for-the-model"></a>
</h4>
<ul>
<li><span class="math inline">\(h_k^* \sim Beta(1,1)\)</span></li>
<li>
<span class="math inline">\(\tau = \sigma^{-2} \sim Gamma(p =
10^{-3},q = 10^{-3})\)</span> with <span class="math inline">\(\sigma_k
= \sigma\)</span>, <span class="math inline">\(\forall k\)</span>
</li>
</ul>
<p>With two different elicitation for <span class="math inline">\(S^*_k\)</span>:</p>
<p>a simple uniform ellicitation:</p>
<ul>
<li><span class="math inline">\(S_k^* \sim Uniform(0,200)\)</span></li>
</ul>
<p>or a more refined gamma elicitation:</p>
<ul>
<li><span class="math inline">\(\mu_{S^*} = 40
\text{eggs/$m^2$}\)</span></li>
<li><span class="math inline">\(CV_{S^*} = 1\)</span></li>
<li><span class="math inline">\(a = CV_{S^*}^{-2}\)</span></li>
<li><span class="math inline">\(b =
\mu_{S^*}^{-1}CV_{S^*}^{-2}\)</span></li>
<li><span class="math inline">\(S_k^* \sim Gamma(a,b) \mathbf{1}_{S_k^*
&lt; 200}\)</span></li>
</ul>
</div>
<div class="section level3">
<h3 id="implementation-and-esimation-of-the-models-in-stan">Implementation and esimation of the models in Stan<a class="anchor" aria-label="anchor" href="#implementation-and-esimation-of-the-models-in-stan"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">SRSalmon</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 12</span></span>
<span><span class="co">#&gt;  $ n_riv      : num 13</span></span>
<span><span class="co">#&gt;  $ name_riv   : chr [1:13] "Nivelle" "Oir" "Frome" "Dee" ...</span></span>
<span><span class="co">#&gt;  $ country_riv: chr [1:13] "France" "France" "England" "England" ...</span></span>
<span><span class="co">#&gt;  $ area       : num [1:13] 320995 48000 876420 6170000 155000 ...</span></span>
<span><span class="co">#&gt;  $ n_obs      : num [1:13] 12 14 12 9 12 7 13 13 11 12 ...</span></span>
<span><span class="co">#&gt;  $ n          : num 139</span></span>
<span><span class="co">#&gt;  $ riv        : num [1:139] 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ S          : num [1:139] 0.957 0.501 2.286 1.481 1.596 ...</span></span>
<span><span class="co">#&gt;  $ R          : num [1:139] 2.647 0.444 1.801 0.573 0.356 ...</span></span>
<span><span class="co">#&gt;  $ lat        : num [1:13] 43.5 48.5 50.5 53 54 ...</span></span>
<span><span class="co">#&gt;  $ lat_pred   : num [1:4] 46 52 59 63</span></span>
<span><span class="co">#&gt;  $ n_pred     : num 4</span></span></code></pre></div>
<div class="section level4">
<h4 id="model-with-no-covariates-and-with-uniform-ellicitation-for-s">Model with no covariates and with uniform ellicitation for <span class="math inline">\(S^*\)</span><a class="anchor" aria-label="anchor" href="#model-with-no-covariates-and-with-uniform-ellicitation-for-s"></a>
</h4>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hsr_model_stan</span> <span class="op">&lt;-</span> <span class="st">"</span></span>
<span><span class="st">data {</span></span>
<span><span class="st">  int n_riv; // Number of rivers</span></span>
<span><span class="st">  int n_obs[n_riv]; // Number of observations by rivers</span></span>
<span><span class="st">  int n; // Total number of observations</span></span>
<span><span class="st">  int riv[n]; // River membership (indices k)</span></span>
<span><span class="st">  vector[n] S; // Stock data</span></span>
<span><span class="st">  vector[n] R; // Recruitment data</span></span>
<span><span class="st">}</span></span>
<span><span class="st"></span></span>
<span><span class="st">parameters {</span></span>
<span><span class="st">  vector&lt;lower=0, upper=200&gt;[n_riv] Sopt;</span></span>
<span><span class="st">  vector&lt;lower=0, upper=1&gt;[n_riv] hopt;</span></span>
<span><span class="st">  real&lt;lower=0&gt; tau;</span></span>
<span><span class="st">}</span></span>
<span><span class="st"></span></span>
<span><span class="st">transformed parameters {</span></span>
<span><span class="st">  vector&lt;lower=0&gt;[n_riv] alpha;</span></span>
<span><span class="st">  vector&lt;lower=0&gt;[n_riv] beta ;</span></span>
<span><span class="st">  real&lt;lower=0&gt; sigma;</span></span>
<span><span class="st">  // real Copt;</span></span>
<span><span class="st">  // real Ropt;</span></span>
<span><span class="st">  vector[n] LogR;</span></span>
<span><span class="st">  // real Slope;</span></span>
<span><span class="st">  </span></span>
<span><span class="st">  for (k in 1:n_riv) {</span></span>
<span><span class="st">    alpha[k] = exp(hopt[k])/(1-hopt[k]) ;  </span></span>
<span><span class="st">    beta[k] = hopt[k]/Sopt[k]     ;    </span></span>
<span><span class="st">  }</span></span>
<span><span class="st">  sigma = tau^-0.5        ;  </span></span>
<span><span class="st">  // Copt = hopt*Sopt/(1-hopt);</span></span>
<span><span class="st">  // Ropt = Sopt + Copt;</span></span>
<span><span class="st">  // Slope = exp(alpha);</span></span>
<span><span class="st">  for (t in 1:n) {</span></span>
<span><span class="st">    LogR[t] = log(S[t]) + log(alpha[riv[t]]) - beta[riv[t]]*S[t] ;  // LogR[t] is the logarithm of the Ricker function  </span></span>
<span><span class="st">  }</span></span>
<span><span class="st">}</span></span>
<span><span class="st"></span></span>
<span><span class="st">model {</span></span>
<span><span class="st">  tau ~ gamma(.001, .001) ; // Diffuse prior for the variance</span></span>
<span><span class="st">  for (k in 1:n_riv) {</span></span>
<span><span class="st">    hopt[k] ~ beta(1,1) ;   </span></span>
<span><span class="st">    Sopt[k] ~ uniform(0, 200) ;</span></span>
<span><span class="st">  }</span></span>
<span><span class="st">// </span></span>
<span><span class="st">    log(R) ~ normal(LogR, sigma) ;</span></span>
<span><span class="st">}</span></span>
<span><span class="st">"</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_name</span> <span class="op">&lt;-</span><span class="st">"HSR_Ricker_LogN_Management"</span></span>
<span><span class="va">sm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_model.html" class="external-link">stan_model</a></span><span class="op">(</span>model_code <span class="op">=</span>  <span class="va">hsr_model_stan</span>,</span>
<span>                 model_name <span class="op">=</span>  <span class="va">model_name</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Trying to compile a simple C file</span></span>
<span><span class="co">#&gt; Running /usr/lib/R/bin/R CMD SHLIB foo.c</span></span>
<span><span class="co">#&gt; gcc -I"/usr/share/R/include" -DNDEBUG   -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/Rcpp/include/"  -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/"  -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/unsupported"  -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/BH/include" -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/StanHeaders/include/src/"  -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/StanHeaders/include/"  -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppParallel/include/"  -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/rstan/include" -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DBOOST_NO_AUTO_PTR  -include '/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp'  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1      -fpic  -g -O2 -fdebug-prefix-map=/build/r-base-zYgbYq/r-base-4.2.1=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2  -c foo.c -o foo.o</span></span>
<span><span class="co">#&gt; In file included from /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/Eigen/Core:88,</span></span>
<span><span class="co">#&gt;                  from /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/Eigen/Dense:1,</span></span>
<span><span class="co">#&gt;                  from /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13,</span></span>
<span><span class="co">#&gt;                  from &lt;command-line&gt;:</span></span>
<span><span class="co">#&gt; /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:1: error: unknown type name ‘namespace’</span></span>
<span><span class="co">#&gt;   628 | namespace Eigen {</span></span>
<span><span class="co">#&gt;       | ^~~~~~~~~</span></span>
<span><span class="co">#&gt; /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:17: error: expected ‘=’, ‘,’, ‘;’, ‘asm’ or ‘__attribute__’ before ‘{’ token</span></span>
<span><span class="co">#&gt;   628 | namespace Eigen {</span></span>
<span><span class="co">#&gt;       |                 ^</span></span>
<span><span class="co">#&gt; In file included from /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/Eigen/Dense:1,</span></span>
<span><span class="co">#&gt;                  from /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13,</span></span>
<span><span class="co">#&gt;                  from &lt;command-line&gt;:</span></span>
<span><span class="co">#&gt; /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/Eigen/Core:96:10: fatal error: complex: No such file or directory</span></span>
<span><span class="co">#&gt;    96 | #include &lt;complex&gt;</span></span>
<span><span class="co">#&gt;       |          ^~~~~~~~~</span></span>
<span><span class="co">#&gt; compilation terminated.</span></span>
<span><span class="co">#&gt; make: *** [/usr/lib/R/etc/Makeconf:168: foo.o] Error 1</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="co"># Number iteration for the "warm up" phase</span></span>
<span><span class="va">n_warm</span> <span class="op">&lt;-</span> <span class="fl">2500</span></span>
<span><span class="co"># Number iteration for inferences</span></span>
<span><span class="va">n_iter</span> <span class="op">&lt;-</span> <span class="fl">5000</span></span>
<span><span class="va">n_thin</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="co"># Number of chains</span></span>
<span><span class="va">n_chains</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span></span>
<span><span class="co"># Inferences</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sm</span>,</span>
<span>                data <span class="op">=</span> <span class="va">SRSalmon</span>, </span>
<span>                pars <span class="op">=</span> <span class="cn">NA</span>, <span class="co">#params,</span></span>
<span>                chains <span class="op">=</span> <span class="va">n_chains</span>, </span>
<span>                iter <span class="op">=</span> <span class="va">n_iter</span>, </span>
<span>                warmup <span class="op">=</span> <span class="va">n_warm</span>, </span>
<span>                thin <span class="op">=</span> <span class="va">n_thin</span>, </span>
<span>                control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"adapt_delta"</span> <span class="op">=</span> <span class="fl">.85</span><span class="op">)</span> <span class="co"># Acceptance rate up from .8 to remove some divergent transitions</span></span>
<span>                <span class="co">#control = list("max_treedepth" = 12)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Diagnostic of the convergence:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sopt"</span>,<span class="st">"hopt"</span>,<span class="st">"tau"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_plot_diagnostics.html" class="external-link">stan_rhat</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span></code></pre></div>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unif-diagnostic-1.png" width="700"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/rstan/reference/monitor.html" class="external-link">monitor</a></span><span class="op">(</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="va">params</span>, permuted <span class="op">=</span> <span class="cn">FALSE</span>, inc_warmup <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for the input samples (4 chains: each with iter = 5000; warmup = 2500):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            Q5   Q50   Q95  Mean   SD  Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; Sopt[1]   0.3   0.5   0.7   0.5  0.1  1.00     3230     2104</span></span>
<span><span class="co">#&gt; Sopt[2]   0.4   1.1   1.9   1.1  0.5  1.00     3572     2468</span></span>
<span><span class="co">#&gt; Sopt[3]   2.1   2.8 136.6  18.2 42.2  1.01      674     1084</span></span>
<span><span class="co">#&gt; Sopt[4]   1.1  56.3 184.0  69.5 64.9  1.00     1109     3902</span></span>
<span><span class="co">#&gt; Sopt[5]   5.9  84.4 187.3  88.8 60.0  1.00     3074     2002</span></span>
<span><span class="co">#&gt; Sopt[6]   7.4  95.9 189.6  97.3 58.7  1.00     6825     4102</span></span>
<span><span class="co">#&gt; Sopt[7]   2.3  20.9 180.4  55.0 62.2  1.00     1748     5784</span></span>
<span><span class="co">#&gt; Sopt[8]   0.8   1.2  39.0   7.4 27.7  1.00     1693      795</span></span>
<span><span class="co">#&gt; Sopt[9]   6.2   8.3  14.7   9.9 10.1  1.00     4348     1993</span></span>
<span><span class="co">#&gt; Sopt[10]  2.6   9.9 176.8  47.6 59.9  1.00     1758     5542</span></span>
<span><span class="co">#&gt; Sopt[11] 10.6  93.6 189.1  95.6 58.3  1.00     5489     4772</span></span>
<span><span class="co">#&gt; Sopt[12] 14.5 102.1 189.8 101.7 56.6  1.00     7631     6317</span></span>
<span><span class="co">#&gt; Sopt[13] 28.6 103.3 189.7 105.6 52.0  1.00     4054     4542</span></span>
<span><span class="co">#&gt; hopt[1]   0.1   0.3   0.5   0.3  0.1  1.00     3257     2187</span></span>
<span><span class="co">#&gt; hopt[2]   0.0   0.1   0.3   0.1  0.1  1.00     3831     2456</span></span>
<span><span class="co">#&gt; hopt[3]   0.0   0.4   0.6   0.4  0.2  1.01      613     1060</span></span>
<span><span class="co">#&gt; hopt[4]   0.1   0.3   0.7   0.3  0.2  1.00     1050     3301</span></span>
<span><span class="co">#&gt; hopt[5]   0.4   0.5   0.7   0.5  0.1  1.00     3663     1792</span></span>
<span><span class="co">#&gt; hopt[6]   0.2   0.3   0.4   0.3  0.1  1.00     7582     4514</span></span>
<span><span class="co">#&gt; hopt[7]   0.5   0.6   0.8   0.6  0.1  1.00     1833     5191</span></span>
<span><span class="co">#&gt; hopt[8]   0.6   0.8   0.8   0.7  0.1  1.00     1764      985</span></span>
<span><span class="co">#&gt; hopt[9]   0.7   0.8   0.9   0.8  0.1  1.00     4725     2291</span></span>
<span><span class="co">#&gt; hopt[10]  0.2   0.4   0.6   0.4  0.1  1.00     1766     5338</span></span>
<span><span class="co">#&gt; hopt[11]  0.0   0.2   0.4   0.2  0.1  1.00     3992     2883</span></span>
<span><span class="co">#&gt; hopt[12]  0.3   0.4   0.5   0.4  0.1  1.00     8919     6485</span></span>
<span><span class="co">#&gt; hopt[13]  0.5   0.6   0.7   0.6  0.1  1.00     5358     3892</span></span>
<span><span class="co">#&gt; tau       2.8   3.7   4.7   3.7  0.6  1.01     1225     2927</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; For each parameter, Bulk_ESS and Tail_ESS are crude measures of </span></span>
<span><span class="co">#&gt; effective sample size for bulk and tail quantities respectively (an ESS &gt; 100 </span></span>
<span><span class="co">#&gt; per chain is considered good), and Rhat is the potential scale reduction </span></span>
<span><span class="co">#&gt; factor on rank normalized split chains (at convergence, Rhat &lt;= 1.05).</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit</span>, par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lp__"</span>, <span class="va">params</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: HSR_Ricker_LogN_Management.</span></span>
<span><span class="co">#&gt; 4 chains, each with iter=5000; warmup=2500; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=2500, total post-warmup draws=10000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            mean se_mean    sd  2.5%   25%    50%    75%  97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; lp__      26.21    0.22  5.38 14.33 22.77  26.61  30.14  35.40   623 1.01</span></span>
<span><span class="co">#&gt; Sopt[1]    0.51    0.00  0.12  0.22  0.44   0.53   0.59   0.71  2631 1.00</span></span>
<span><span class="co">#&gt; Sopt[2]    1.11    0.01  0.46  0.24  0.78   1.11   1.43   1.99  3693 1.00</span></span>
<span><span class="co">#&gt; Sopt[3]   18.23    2.08 42.23  1.99  2.51   2.84   3.52 168.77   412 1.02</span></span>
<span><span class="co">#&gt; Sopt[4]   69.47    1.74 64.93  1.06  2.52  56.25 125.33 192.80  1390 1.00</span></span>
<span><span class="co">#&gt; Sopt[5]   88.80    0.93 60.05  4.65 32.68  84.36 140.52 193.90  4161 1.00</span></span>
<span><span class="co">#&gt; Sopt[6]   97.25    0.64 58.73  3.45 45.79  95.94 148.59 194.98  8301 1.00</span></span>
<span><span class="co">#&gt; Sopt[7]   55.04    1.31 62.22  2.09  3.68  20.86 103.51 190.79  2249 1.00</span></span>
<span><span class="co">#&gt; Sopt[8]    7.43    0.96 27.68  0.81  1.00   1.16   1.45 116.59   830 1.00</span></span>
<span><span class="co">#&gt; Sopt[9]    9.87    0.32 10.06  5.96  7.27   8.29   9.81  19.59   965 1.00</span></span>
<span><span class="co">#&gt; Sopt[10]  47.64    1.31 59.91  2.48  3.62   9.86  84.24 188.54  2087 1.00</span></span>
<span><span class="co">#&gt; Sopt[11]  95.63    0.73 58.29  8.17 42.54  93.65 145.98 194.77  6334 1.00</span></span>
<span><span class="co">#&gt; Sopt[12] 101.75    0.61 56.65  9.70 51.97 102.13 150.95 194.63  8597 1.00</span></span>
<span><span class="co">#&gt; Sopt[13] 105.57    0.77 51.99 23.91 59.75 103.31 150.03 194.79  4586 1.00</span></span>
<span><span class="co">#&gt; hopt[1]    0.31    0.00  0.13  0.08  0.22   0.31   0.40   0.56  3500 1.00</span></span>
<span><span class="co">#&gt; hopt[2]    0.15    0.00  0.08  0.02  0.09   0.14   0.20   0.33  4823 1.00</span></span>
<span><span class="co">#&gt; hopt[3]    0.35    0.01  0.16  0.02  0.25   0.38   0.47   0.61   465 1.01</span></span>
<span><span class="co">#&gt; hopt[4]    0.32    0.01  0.17  0.08  0.20   0.27   0.39   0.73   841 1.00</span></span>
<span><span class="co">#&gt; hopt[5]    0.48    0.00  0.09  0.35  0.43   0.47   0.52   0.73  2251 1.00</span></span>
<span><span class="co">#&gt; hopt[6]    0.31    0.00  0.09  0.14  0.25   0.31   0.36   0.48  6493 1.00</span></span>
<span><span class="co">#&gt; hopt[7]    0.63    0.00  0.10  0.47  0.55   0.60   0.71   0.83  1603 1.00</span></span>
<span><span class="co">#&gt; hopt[8]    0.75    0.00  0.08  0.52  0.71   0.76   0.80   0.86  1003 1.00</span></span>
<span><span class="co">#&gt; hopt[9]    0.80    0.00  0.06  0.65  0.77   0.81   0.84   0.89  3000 1.00</span></span>
<span><span class="co">#&gt; hopt[10]   0.38    0.00  0.14  0.16  0.28   0.36   0.49   0.65  1611 1.00</span></span>
<span><span class="co">#&gt; hopt[11]   0.20    0.00  0.12  0.02  0.12   0.18   0.26   0.50  4151 1.00</span></span>
<span><span class="co">#&gt; hopt[12]   0.43    0.00  0.07  0.28  0.38   0.43   0.48   0.57  8462 1.00</span></span>
<span><span class="co">#&gt; hopt[13]   0.58    0.00  0.08  0.44  0.52   0.57   0.62   0.78  4580 1.00</span></span>
<span><span class="co">#&gt; tau        3.73    0.02  0.57  2.69  3.33   3.71   4.10   4.92  1232 1.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Mon Aug 29 19:55:21 2022.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dfw_unif</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_wider.html">extract_wider</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="va">dfl_unif</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_longer.html">extract_longer</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dfl_unif</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="st">"Sopt"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Site <span class="op">=</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">name_riv</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"Sopt."</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">Site</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey80"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"log(S*)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">plot_theme</span></span></code></pre></div>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dfl_unif</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="st">"hopt"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Site <span class="op">=</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">name_riv</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"hopt."</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">Site</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey80"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"log(h*)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">plot_theme</span></span></code></pre></div>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="model-with-no-covariates-and-with-gamma-prior-for-s">Model with no covariates and with Gamma prior for <span class="math inline">\(S*\)</span><a class="anchor" aria-label="anchor" href="#model-with-no-covariates-and-with-gamma-prior-for-s"></a>
</h4>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hsr_model_indep_S_gamma_stan</span> <span class="op">&lt;-</span> <span class="st">"</span></span>
<span><span class="st">data {</span></span>
<span><span class="st">  int n_riv; // Number of rivers</span></span>
<span><span class="st">  int n_obs[n_riv]; // Number of observations by rivers</span></span>
<span><span class="st">  int n; // Total number of observations</span></span>
<span><span class="st">  int riv[n]; // River membership (indices k)</span></span>
<span><span class="st">  vector[n] S; // Stock data</span></span>
<span><span class="st">  vector[n] R; // Recruitment data</span></span>
<span><span class="st">}</span></span>
<span><span class="st"></span></span>
<span><span class="st">parameters {</span></span>
<span><span class="st">  vector&lt;lower=0, upper=200&gt;[n_riv] Sopt;</span></span>
<span><span class="st">  vector&lt;lower=0, upper=1&gt;[n_riv] hopt;</span></span>
<span><span class="st">  real&lt;lower=0&gt; tau;</span></span>
<span><span class="st">}</span></span>
<span><span class="st"></span></span>
<span><span class="st">transformed parameters {</span></span>
<span><span class="st">  vector&lt;lower=0&gt;[n_riv] alpha;</span></span>
<span><span class="st">  vector&lt;lower=0&gt;[n_riv] beta ;</span></span>
<span><span class="st">  real&lt;lower=0&gt; sigma;</span></span>
<span><span class="st">  // real Copt;</span></span>
<span><span class="st">  // real Ropt;</span></span>
<span><span class="st">  vector[n] LogR;</span></span>
<span><span class="st">  // real Slope;</span></span>
<span><span class="st">  </span></span>
<span><span class="st">  for (k in 1:n_riv) {</span></span>
<span><span class="st">    alpha[k] = exp(hopt[k])/(1-hopt[k]) ;  </span></span>
<span><span class="st">    beta[k] = hopt[k]/Sopt[k]     ;    </span></span>
<span><span class="st">  }</span></span>
<span><span class="st">  sigma = tau^-0.5        ;  </span></span>
<span><span class="st">  // Copt = hopt*Sopt/(1-hopt);</span></span>
<span><span class="st">  // Ropt = Sopt + Copt;</span></span>
<span><span class="st">  // Slope = exp(alpha);</span></span>
<span><span class="st">  for (t in 1:n) {</span></span>
<span><span class="st">    LogR[t] = log(S[t]) + log(alpha[riv[t]]) - beta[riv[t]]*S[t] ;  // LogR[t] is the logarithm of the Ricker function  </span></span>
<span><span class="st">  }</span></span>
<span><span class="st">}</span></span>
<span><span class="st"></span></span>
<span><span class="st">model {</span></span>
<span><span class="st">  tau ~ gamma(.001, .001) ; // Diffuse prior for the variance</span></span>
<span><span class="st">  for (k in 1:n_riv) {</span></span>
<span><span class="st">    hopt[k] ~ beta(1,1) ;   </span></span>
<span><span class="st">    Sopt[k] ~ gamma(1, 1./1600) ;</span></span>
<span><span class="st">  }</span></span>
<span><span class="st">// </span></span>
<span><span class="st">    log(R) ~ normal(LogR, sigma) ;</span></span>
<span><span class="st">}</span></span>
<span><span class="st">"</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">model_name</span> <span class="op">&lt;-</span><span class="st">"HSR_Ricker_LogN_Management_S_gamma"</span></span>
<span><span class="va">sm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_model.html" class="external-link">stan_model</a></span><span class="op">(</span>model_code <span class="op">=</span>  <span class="va">hsr_model_indep_S_gamma_stan</span>,</span>
<span>                 model_name <span class="op">=</span>  <span class="va">model_name</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Running /usr/lib/R/bin/R CMD SHLIB foo.c</span></span>
<span><span class="co">#&gt; gcc -I"/usr/share/R/include" -DNDEBUG   -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/Rcpp/include/"  -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/"  -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/unsupported"  -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/BH/include" -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/StanHeaders/include/src/"  -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/StanHeaders/include/"  -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppParallel/include/"  -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/rstan/include" -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DBOOST_NO_AUTO_PTR  -include '/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp'  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1      -fpic  -g -O2 -fdebug-prefix-map=/build/r-base-zYgbYq/r-base-4.2.1=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2  -c foo.c -o foo.o</span></span>
<span><span class="co">#&gt; In file included from /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/Eigen/Core:88,</span></span>
<span><span class="co">#&gt;                  from /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/Eigen/Dense:1,</span></span>
<span><span class="co">#&gt;                  from /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13,</span></span>
<span><span class="co">#&gt;                  from &lt;command-line&gt;:</span></span>
<span><span class="co">#&gt; /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:1: error: unknown type name ‘namespace’</span></span>
<span><span class="co">#&gt;   628 | namespace Eigen {</span></span>
<span><span class="co">#&gt;       | ^~~~~~~~~</span></span>
<span><span class="co">#&gt; /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:17: error: expected ‘=’, ‘,’, ‘;’, ‘asm’ or ‘__attribute__’ before ‘{’ token</span></span>
<span><span class="co">#&gt;   628 | namespace Eigen {</span></span>
<span><span class="co">#&gt;       |                 ^</span></span>
<span><span class="co">#&gt; In file included from /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/Eigen/Dense:1,</span></span>
<span><span class="co">#&gt;                  from /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13,</span></span>
<span><span class="co">#&gt;                  from &lt;command-line&gt;:</span></span>
<span><span class="co">#&gt; /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/Eigen/Core:96:10: fatal error: complex: No such file or directory</span></span>
<span><span class="co">#&gt;    96 | #include &lt;complex&gt;</span></span>
<span><span class="co">#&gt;       |          ^~~~~~~~~</span></span>
<span><span class="co">#&gt; compilation terminated.</span></span>
<span><span class="co">#&gt; make: *** [/usr/lib/R/etc/Makeconf:168: foo.o] Error 1</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="co"># Number iteration for the "warm up" phase</span></span>
<span><span class="va">n_warm</span> <span class="op">&lt;-</span> <span class="fl">2500</span></span>
<span><span class="co"># Number iteration for inferences</span></span>
<span><span class="va">n_iter</span> <span class="op">&lt;-</span> <span class="fl">5000</span></span>
<span><span class="va">n_thin</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="co"># Number of chains</span></span>
<span><span class="va">n_chains</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span></span>
<span><span class="va">params</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sopt"</span>,<span class="st">"hopt"</span>,<span class="st">"tau"</span><span class="op">)</span></span>
<span><span class="co"># Inferences</span></span>
<span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sm</span>,</span>
<span>                data <span class="op">=</span> <span class="va">SRSalmon</span>, </span>
<span>                pars <span class="op">=</span> <span class="cn">NA</span>, <span class="co">#params,</span></span>
<span>                chains <span class="op">=</span> <span class="va">n_chains</span>, </span>
<span>                iter <span class="op">=</span> <span class="va">n_iter</span>, </span>
<span>                warmup <span class="op">=</span> <span class="va">n_warm</span>, </span>
<span>                thin <span class="op">=</span> <span class="va">n_thin</span>, </span>
<span>                control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"adapt_delta"</span> <span class="op">=</span> <span class="fl">.85</span><span class="op">)</span><span class="co"># Acceptance rate up from .8 to remove some divergent transitions</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Diagnostic of the convergence:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sopt"</span>,<span class="st">"hopt"</span>,<span class="st">"tau"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_plot_diagnostics.html" class="external-link">stan_rhat</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span></code></pre></div>
<p><img src="hierarchical-stock-recruitment_files/figure-html/gamma-diagnostic-1.png" width="700"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/rstan/reference/monitor.html" class="external-link">monitor</a></span><span class="op">(</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="va">params</span>, permuted <span class="op">=</span> <span class="cn">FALSE</span>, inc_warmup <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for the input samples (4 chains: each with iter = 5000; warmup = 2500):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            Q5   Q50   Q95  Mean   SD  Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; Sopt[1]   0.3   0.5   0.7   0.5  0.1  1.00     3281     1910</span></span>
<span><span class="co">#&gt; Sopt[2]   0.4   1.1   1.9   1.1  0.4  1.00     3864     2874</span></span>
<span><span class="co">#&gt; Sopt[3]   2.1   2.8 123.8  16.3 39.1  1.00      906     1235</span></span>
<span><span class="co">#&gt; Sopt[4]   1.1  48.9 183.7  66.6 64.6  1.00     1257     4396</span></span>
<span><span class="co">#&gt; Sopt[5]   5.9  78.5 187.0  85.1 60.0  1.00     3312     2234</span></span>
<span><span class="co">#&gt; Sopt[6]   6.7  92.5 188.8  95.1 58.8  1.00     6604     3476</span></span>
<span><span class="co">#&gt; Sopt[7]   2.2  18.2 176.7  52.4 60.5  1.00     1976     5773</span></span>
<span><span class="co">#&gt; Sopt[8]   0.8   1.2  44.3   7.6 27.8  1.00     1548      648</span></span>
<span><span class="co">#&gt; Sopt[9]   6.2   8.3  14.0   9.1  3.9  1.00     4717     3206</span></span>
<span><span class="co">#&gt; Sopt[10]  2.7   8.6 173.9  45.9 58.6  1.00     1736     6340</span></span>
<span><span class="co">#&gt; Sopt[11] 10.3  87.7 187.7  91.9 59.0  1.00     6135     5340</span></span>
<span><span class="co">#&gt; Sopt[12] 14.8  97.9 190.2 100.0 56.6  1.00     6915     5028</span></span>
<span><span class="co">#&gt; Sopt[13] 27.4 100.0 189.2 103.6 52.0  1.00     3616     3879</span></span>
<span><span class="co">#&gt; hopt[1]   0.1   0.3   0.5   0.3  0.1  1.00     3112     1735</span></span>
<span><span class="co">#&gt; hopt[2]   0.0   0.1   0.3   0.2  0.1  1.00     3997     2839</span></span>
<span><span class="co">#&gt; hopt[3]   0.0   0.4   0.6   0.4  0.2  1.01      789      978</span></span>
<span><span class="co">#&gt; hopt[4]   0.1   0.3   0.7   0.3  0.2  1.00     1235     4129</span></span>
<span><span class="co">#&gt; hopt[5]   0.4   0.5   0.7   0.5  0.1  1.00     4065     2135</span></span>
<span><span class="co">#&gt; hopt[6]   0.2   0.3   0.5   0.3  0.1  1.00     6894     4684</span></span>
<span><span class="co">#&gt; hopt[7]   0.5   0.6   0.8   0.6  0.1  1.00     2054     5313</span></span>
<span><span class="co">#&gt; hopt[8]   0.6   0.8   0.8   0.7  0.1  1.00     1601      762</span></span>
<span><span class="co">#&gt; hopt[9]   0.7   0.8   0.9   0.8  0.1  1.00     4764     3686</span></span>
<span><span class="co">#&gt; hopt[10]  0.2   0.4   0.6   0.4  0.1  1.00     1697     4804</span></span>
<span><span class="co">#&gt; hopt[11]  0.0   0.2   0.4   0.2  0.1  1.00     5131     3521</span></span>
<span><span class="co">#&gt; hopt[12]  0.3   0.4   0.5   0.4  0.1  1.00     8140     5414</span></span>
<span><span class="co">#&gt; hopt[13]  0.5   0.6   0.7   0.6  0.1  1.00     5063     3527</span></span>
<span><span class="co">#&gt; tau       2.9   3.7   4.7   3.7  0.6  1.00     1499     3492</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; For each parameter, Bulk_ESS and Tail_ESS are crude measures of </span></span>
<span><span class="co">#&gt; effective sample size for bulk and tail quantities respectively (an ESS &gt; 100 </span></span>
<span><span class="co">#&gt; per chain is considered good), and Rhat is the potential scale reduction </span></span>
<span><span class="co">#&gt; factor on rank normalized split chains (at convergence, Rhat &lt;= 1.05).</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit</span>, par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lp__"</span>, <span class="va">params</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: HSR_Ricker_LogN_Management_S_gamma.</span></span>
<span><span class="co">#&gt; 4 chains, each with iter=5000; warmup=2500; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=2500, total post-warmup draws=10000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            mean se_mean    sd  2.5%   25%   50%    75%  97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; lp__      26.02    0.19  5.24 14.73 22.67 26.39  29.74  35.24   778 1.01</span></span>
<span><span class="co">#&gt; Sopt[1]    0.51    0.00  0.13  0.21  0.44  0.53   0.60   0.72  2668 1.00</span></span>
<span><span class="co">#&gt; Sopt[2]    1.12    0.01  0.45  0.28  0.80  1.12   1.43   1.99  4105 1.00</span></span>
<span><span class="co">#&gt; Sopt[3]   16.30    1.64 39.07  2.01  2.51  2.84   3.47 160.48   568 1.01</span></span>
<span><span class="co">#&gt; Sopt[4]   66.61    1.62 64.57  1.06  2.18 48.85 121.70 191.90  1591 1.00</span></span>
<span><span class="co">#&gt; Sopt[5]   85.15    0.88 60.02  4.53 28.80 78.52 136.63 193.00  4655 1.00</span></span>
<span><span class="co">#&gt; Sopt[6]   95.08    0.64 58.82  3.18 43.41 92.51 146.30 194.66  8318 1.00</span></span>
<span><span class="co">#&gt; Sopt[7]   52.36    1.21 60.49  2.04  3.61 18.23  96.33 189.11  2496 1.00</span></span>
<span><span class="co">#&gt; Sopt[8]    7.57    1.10 27.76  0.81  1.00  1.16   1.45 116.83   637 1.01</span></span>
<span><span class="co">#&gt; Sopt[9]    9.11    0.08  3.94  5.94  7.29  8.30   9.80  16.84  2625 1.00</span></span>
<span><span class="co">#&gt; Sopt[10]  45.89    1.37 58.65  2.49  3.58  8.59  80.33 187.28  1832 1.00</span></span>
<span><span class="co">#&gt; Sopt[11]  91.90    0.70 59.04  8.15 36.32 87.74 143.43 193.71  7048 1.00</span></span>
<span><span class="co">#&gt; Sopt[12]  99.96    0.63 56.60  9.76 49.92 97.89 149.17 194.59  8039 1.00</span></span>
<span><span class="co">#&gt; Sopt[13] 103.62    0.81 51.97 22.67 58.37 99.98 147.70 194.97  4163 1.00</span></span>
<span><span class="co">#&gt; hopt[1]    0.31    0.00  0.13  0.08  0.22  0.31   0.40   0.56  3429 1.00</span></span>
<span><span class="co">#&gt; hopt[2]    0.15    0.00  0.08  0.03  0.09  0.14   0.20   0.32  5004 1.00</span></span>
<span><span class="co">#&gt; hopt[3]    0.36    0.01  0.16  0.02  0.26  0.39   0.48   0.61   633 1.01</span></span>
<span><span class="co">#&gt; hopt[4]    0.32    0.01  0.17  0.09  0.20  0.27   0.41   0.72   944 1.00</span></span>
<span><span class="co">#&gt; hopt[5]    0.49    0.00  0.09  0.35  0.43  0.47   0.52   0.73  2598 1.00</span></span>
<span><span class="co">#&gt; hopt[6]    0.31    0.00  0.09  0.14  0.25  0.31   0.36   0.49  5487 1.00</span></span>
<span><span class="co">#&gt; hopt[7]    0.63    0.00  0.10  0.47  0.55  0.60   0.71   0.83  1800 1.00</span></span>
<span><span class="co">#&gt; hopt[8]    0.75    0.00  0.08  0.52  0.71  0.76   0.80   0.86   864 1.01</span></span>
<span><span class="co">#&gt; hopt[9]    0.80    0.00  0.06  0.66  0.77  0.81   0.84   0.89  4043 1.00</span></span>
<span><span class="co">#&gt; hopt[10]   0.39    0.00  0.14  0.16  0.28  0.37   0.50   0.65  1556 1.00</span></span>
<span><span class="co">#&gt; hopt[11]   0.21    0.00  0.12  0.02  0.12  0.19   0.27   0.52  5260 1.00</span></span>
<span><span class="co">#&gt; hopt[12]   0.43    0.00  0.08  0.28  0.38  0.43   0.48   0.57  7608 1.00</span></span>
<span><span class="co">#&gt; hopt[13]   0.58    0.00  0.08  0.44  0.53  0.57   0.63   0.79  4246 1.00</span></span>
<span><span class="co">#&gt; tau        3.74    0.01  0.57  2.71  3.34  3.71   4.11   4.93  1477 1.00</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Mon Aug 29 19:56:14 2022.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dfw_gamma</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_wider.html">extract_wider</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Model <span class="op">=</span> <span class="st">"Gamma"</span><span class="op">)</span></span>
<span><span class="va">dfl_gamma</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_longer.html">extract_longer</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dfl_gamma</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="st">"Sopt"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Site <span class="op">=</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">name_riv</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"Sopt."</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">Site</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey80"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"log(S*)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">plot_theme</span></span></code></pre></div>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dfl_gamma</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="st">"hopt"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Site <span class="op">=</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">name_riv</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"hopt."</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, x <span class="op">=</span> <span class="va">Site</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey80"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"log(h*)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">plot_theme</span></span></code></pre></div>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>The choice of the prior distribution of <span class="math inline">\(S^*\)</span> does not make much difference on the
posterior distribution estimate.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">dfl_unif</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span> <span class="op">(</span>Model <span class="op">=</span>  <span class="st">"Uniform"</span><span class="op">)</span>, <span class="va">dfl_gamma</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Model <span class="op">=</span> <span class="st">"Gamma"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="st">"Sopt"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Site <span class="op">=</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">name_riv</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"Sopt."</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="va">Model</span>, color <span class="op">=</span> <span class="va">Model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">Site</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"log(S*)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">plot_theme</span></span></code></pre></div>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="hierarchical-model-with-latitudinal-covariates">Hierarchical model with latitudinal covariates<a class="anchor" aria-label="anchor" href="#hierarchical-model-with-latitudinal-covariates"></a>
</h2>
<p>The hierarchical modeling is designed to improve the estimation of
parameters <span class="math inline">\(S^*\)</span> and <span class="math inline">\(h^*\)</span> for data-poor rivers by borrowing
strength from data-rich rivers. It is then designed to capture the
between-rivers variability of the parameters (<span class="math inline">\(S^*\)</span>, <span class="math inline">\(h^*\)</span>) conditionnaly on the latitude. This
can be done by introducing a log-linear relationship between the
expectation of <span class="math inline">\(S^*_k\)</span> and the
latitude of the river <span class="math inline">\(x_k\)</span>:</p>
<ul>
<li><span class="math inline">\(\log(\mu_{S^*_k}) = \alpha x_k +
\beta\)</span></li>
<li><span class="math inline">\(\alpha \sim Uniform(-5,5)\)</span></li>
<li><span class="math inline">\(\beta \sim Uniform(-50,50)\)</span></li>
</ul>
<p><span class="math inline">\(S^*_k\)</span> is drawn from a Gamma
distribution which the parameters depend on the latitude:</p>
<ul>
<li><span class="math inline">\(CV_{S^*} ~ Uniform(0,20)\)</span></li>
<li><span class="math inline">\(a_k = \frac{1}{CV_{S*}^2}\)</span></li>
<li><span class="math inline">\(b_k =
\frac{1}{\mu_{S^*_k}CV^2_{S^*}}\)</span></li>
<li><span class="math inline">\(S^*_k \sim Gamma(a_k,
b_k)1_{S^*_k&lt;200}\)</span></li>
</ul>
<p>Then we express the linear linear relationship between the
expectation of <span class="math inline">\(h^*_k\)</span> and the
latitude of the river <span class="math inline">\(x_k\)</span> on a
logit scale:</p>
<ul>
<li><span class="math inline">\(logit(\mu_{h^*_k}) = \delta x_k +
\kappa\)</span></li>
<li><span class="math inline">\(\delta \sim Uniform(-5,5)\)</span></li>
<li><span class="math inline">\(\kappa \sim
Uniform(-50,50)\)</span></li>
</ul>
<p>Given the expected mean in the logit scale, <span class="math inline">\(logit(h_{k}^{\ast})\)</span> for each river <span class="math inline">\(k\)</span> is drawn in a Normal distribution with
expected mean <span class="math inline">\(logit(\mu_{h_{k}^{\ast}})\)</span> and precision
<span class="math inline">\(\tau_{h^{\ast}}^{-2}\)</span>. A diffuse
prior is set on the precision:</p>
<ul>
<li><span class="math inline">\(logit(h^*_k) \sim Normal(logit(\mu_k^*),
\tau^2)\)</span></li>
<li><span class="math inline">\(\tau^{-2} \sim Gamma(.001,
.001)\)</span></li>
</ul>
<center>
<div class="figure">
<img src="figures/SRSalmon/DAGHierSRLatitude.png" style="width:70.0%;height:70.0%" alt=""><p class="caption">Directed acyclic graph of the stock recruitment model
with covariates</p>
</div>
</center>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hsr_model_hier_S_gamma_stan</span> <span class="op">&lt;-</span> <span class="st">"</span></span>
<span><span class="st">data {</span></span>
<span><span class="st">  int n_riv; // Number of rivers</span></span>
<span><span class="st">  int n_obs[n_riv]; // Number of observations by rivers</span></span>
<span><span class="st">  int n; // Total number of observations</span></span>
<span><span class="st">  int riv[n]; // River membership (indices k)</span></span>
<span><span class="st">  vector&lt;lower=0&gt;[n] S; // Stock data</span></span>
<span><span class="st">  vector&lt;lower=0&gt;[n] R; // Recruitment data</span></span>
<span><span class="st">  vector[n_riv] lat; //Latitude of rivers</span></span>
<span><span class="st">  int n_pred;</span></span>
<span><span class="st">  vector[n_pred] lat_pred;</span></span>
<span><span class="st">}</span></span>
<span><span class="st"></span></span>
<span><span class="st">transformed data {</span></span>
<span><span class="st">  vector[n_riv] lat_rescaled;</span></span>
<span><span class="st">//  real CV_S;</span></span>
<span><span class="st">//  real a;</span></span>
<span><span class="st">//  a = 1/(CV_S*CV_S);</span></span>
<span><span class="st">  lat_rescaled = lat-mean(lat);</span></span>
<span><span class="st">}</span></span>
<span><span class="st"></span></span>
<span><span class="st">parameters {</span></span>
<span><span class="st">  real&lt;lower=0&gt; tau;</span></span>
<span><span class="st"></span></span>
<span><span class="st">  real&lt;lower=0, upper=20&gt; CV_S;</span></span>
<span><span class="st">  real&lt;lower=-5, upper=5&gt; alpha;</span></span>
<span><span class="st">  real&lt;lower=-50, upper=50&gt; beta;</span></span>
<span><span class="st">  vector&lt;lower=0, upper=200&gt;[n_riv] Sopt;  </span></span>
<span><span class="st">  </span></span>
<span><span class="st">  </span></span>
<span><span class="st">  real&lt;lower=-5, upper=5&gt; delta;</span></span>
<span><span class="st">  real&lt;lower=-50, upper=50&gt; kappa;</span></span>
<span><span class="st">  real&lt;lower=0&gt; tau_h;</span></span>
<span><span class="st">  vector[n_riv] logit_h;</span></span>
<span><span class="st">  //vector[n_riv] logit_h_raw; // centered parametrization for logit_h</span></span>
<span><span class="st"></span></span>
<span><span class="st">}</span></span>
<span><span class="st"></span></span>
<span><span class="st">transformed parameters {</span></span>
<span><span class="st">  </span></span>
<span><span class="st">  real&lt;lower=0&gt; sigma;      // stdev for lognormal noise</span></span>
<span><span class="st">  </span></span>
<span><span class="st">//  vector[n_riv] log_mu_S; // log of the expected mean of Sopt</span></span>
<span><span class="st">  vector&lt;lower=0&gt;[n_riv] mu_S; // Expected mean of Sopt  </span></span>
<span><span class="st">  real&lt;lower=0&gt; a; // parameters of the gamma prior of Sopt</span></span>
<span><span class="st">  vector&lt;lower=0&gt;[n_riv] b; // parameters of the gamma prior of Sopt</span></span>
<span><span class="st">  </span></span>
<span><span class="st">  real&lt;lower=0&gt; sigma_h; // stdev for logit of h </span></span>
<span><span class="st">  vector[n_riv] logit_mu_h; // logit of the expected mean of hopt</span></span>
<span><span class="st">  vector&lt;lower=0, upper=1&gt;[n_riv] hopt; </span></span>
<span><span class="st">  </span></span>
<span><span class="st">  //vector[n_riv] logit_h;   // logit of hopt</span></span>
<span><span class="st">  vector[n] LogR;</span></span>
<span><span class="st">  </span></span>
<span><span class="st">  </span></span>
<span><span class="st"></span></span>
<span><span class="st">  sigma = tau^-0.5  ;</span></span>
<span><span class="st">  sigma_h = tau_h^-0.5 ;</span></span>
<span><span class="st"></span></span>
<span><span class="st">  for (k in 1:n_riv) {</span></span>
<span><span class="st">    mu_S[k] = exp(alpha * (lat[k]) + beta) ;</span></span>
<span><span class="st">//    mu_S[k] = exp(alpha * (lat_rescaled[k]) + beta) ;</span></span>
<span><span class="st">//    mu_S[k] = exp(log_mu_S[k]);</span></span>
<span><span class="st">    logit_mu_h[k] = delta * (lat[k]) + kappa ;</span></span>
<span><span class="st">//    logit_mu_h[k] = delta * (lat_rescaled[k]) + kappa ;</span></span>
<span><span class="st">   // logit_h[k] = logit_mu_h[k] + sigma_h * logit_h_raw[k];</span></span>
<span><span class="st">  }</span></span>
<span><span class="st">  </span></span>
<span><span class="st">  a = 1/square(CV_S) ;</span></span>
<span><span class="st">  for (k in 1:n_riv) {</span></span>
<span><span class="st">    b[k] = 1/(mu_S[k]*square(CV_S)) ;</span></span>
<span><span class="st">  }  </span></span>
<span><span class="st">  hopt = inv_logit(logit_h) ;</span></span>
<span><span class="st"></span></span>
<span><span class="st"></span></span>
<span><span class="st">  for (t in 1:n) {</span></span>
<span><span class="st">    LogR[t] = hopt[riv[t]] + log(S[t]) - log(1 - hopt[riv[t]]) - hopt[riv[t]]/Sopt[riv[t]]*S[t] ;  // LogR[t] is the logarithm of the Ricker function  </span></span>
<span><span class="st">  }</span></span>
<span><span class="st">}</span></span>
<span><span class="st"></span></span>
<span><span class="st">model {</span></span>
<span><span class="st">//  alpha ~ uniform(-5, 5);</span></span>
<span><span class="st">//  beta ~ uniform(-50, 50);</span></span>
<span><span class="st">//  CV_S ~ uniform(0, 20);</span></span>
<span><span class="st">  </span></span>
<span><span class="st">//  delta ~ uniform(-5, 5);</span></span>
<span><span class="st">//  kappa ~ uniform(-50, 50);</span></span>
<span><span class="st"></span></span>
<span><span class="st"></span></span>
<span><span class="st">  tau ~ gamma(.001, .001) ; // Diffuse prior for the precision</span></span>
<span><span class="st">  tau_h ~ gamma(.001, .001) ; // Diffuse prior for the precision</span></span>
<span><span class="st"></span></span>
<span><span class="st"></span></span>
<span><span class="st">  //logit_h_raw ~ std_normal();</span></span>
<span><span class="st">  for (k in 1:n_riv) {</span></span>
<span><span class="st">    logit_h[k] ~ normal(logit_mu_h[k], sigma_h);</span></span>
<span><span class="st">    Sopt[k] ~ gamma(a, b[k]) ; // T[0,200] ;</span></span>
<span><span class="st">  }</span></span>
<span><span class="st"></span></span>
<span><span class="st">  </span></span>
<span><span class="st">  log(R) ~ normal(LogR, sigma) ;</span></span>
<span><span class="st">}</span></span>
<span><span class="st"></span></span>
<span><span class="st">generated quantities {</span></span>
<span><span class="st">  real a_pred;</span></span>
<span><span class="st">  vector[n_pred] b_pred;</span></span>
<span><span class="st">  vector[n_pred] Sopt_pred;</span></span>
<span><span class="st">  vector[n_pred] logit_hopt_pred;</span></span>
<span><span class="st">  vector&lt;lower=0,upper=1&gt;[n_pred] hopt_pred;</span></span>
<span><span class="st">  // Posterior Predictive for new rivers with latitude lat_pred[p]</span></span>
<span><span class="st">  a_pred = 1/(CV_S*CV_S);</span></span>
<span><span class="st">  for ( p in 1 : n_pred ) {</span></span>
<span><span class="st">//    b_pred[p] = a/(exp(alpha * lat_pred[p] + beta - alpha * mean(lat)));</span></span>
<span><span class="st">    b_pred[p] = a_pred*(1/exp(alpha * lat_pred[p] + beta));</span></span>
<span><span class="st">    Sopt_pred[p] = gamma_rng(a_pred,b_pred[p]); //T[0,200];</span></span>
<span><span class="st">//    logit_hopt_pred[p] = normal_rng(exp(delta * lat_pred[p] + kappa - delta * mean(lat)), sigma_h);`</span></span>
<span><span class="st">    logit_hopt_pred[p] = normal_rng(delta * lat_pred[p] + kappa, sigma_h);</span></span>
<span><span class="st">    hopt_pred[p] = inv_logit(logit_hopt_pred[p]);</span></span>
<span><span class="st">  } // end loop on predictions p</span></span>
<span><span class="st">} </span></span>
<span><span class="st">"</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_name_hier</span> <span class="op">&lt;-</span><span class="st">"HSR_Ricker_LogN_Management_S_gamma_hier"</span></span>
<span><span class="va">sm_hier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_model.html" class="external-link">stan_model</a></span><span class="op">(</span>model_code <span class="op">=</span>  <span class="va">hsr_model_hier_S_gamma_stan</span>,</span>
<span>                 model_name <span class="op">=</span>  <span class="va">model_name_hier</span><span class="op">)</span></span>
<span><span class="co">#&gt; Trying to compile a simple C file</span></span>
<span><span class="co">#&gt; Running /usr/lib/R/bin/R CMD SHLIB foo.c</span></span>
<span><span class="co">#&gt; gcc -I"/usr/share/R/include" -DNDEBUG   -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/Rcpp/include/"  -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/"  -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/unsupported"  -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/BH/include" -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/StanHeaders/include/src/"  -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/StanHeaders/include/"  -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppParallel/include/"  -I"/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/rstan/include" -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DBOOST_NO_AUTO_PTR  -include '/home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp'  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1      -fpic  -g -O2 -fdebug-prefix-map=/build/r-base-zYgbYq/r-base-4.2.1=. -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2  -c foo.c -o foo.o</span></span>
<span><span class="co">#&gt; In file included from /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/Eigen/Core:88,</span></span>
<span><span class="co">#&gt;                  from /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/Eigen/Dense:1,</span></span>
<span><span class="co">#&gt;                  from /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13,</span></span>
<span><span class="co">#&gt;                  from &lt;command-line&gt;:</span></span>
<span><span class="co">#&gt; /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:1: error: unknown type name ‘namespace’</span></span>
<span><span class="co">#&gt;   628 | namespace Eigen {</span></span>
<span><span class="co">#&gt;       | ^~~~~~~~~</span></span>
<span><span class="co">#&gt; /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/Eigen/src/Core/util/Macros.h:628:17: error: expected ‘=’, ‘,’, ‘;’, ‘asm’ or ‘__attribute__’ before ‘{’ token</span></span>
<span><span class="co">#&gt;   628 | namespace Eigen {</span></span>
<span><span class="co">#&gt;       |                 ^</span></span>
<span><span class="co">#&gt; In file included from /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/Eigen/Dense:1,</span></span>
<span><span class="co">#&gt;                  from /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/StanHeaders/include/stan/math/prim/mat/fun/Eigen.hpp:13,</span></span>
<span><span class="co">#&gt;                  from &lt;command-line&gt;:</span></span>
<span><span class="co">#&gt; /home/chabertliddell/R/x86_64-pc-linux-gnu-library/4.2/RcppEigen/include/Eigen/Core:96:10: fatal error: complex: No such file or directory</span></span>
<span><span class="co">#&gt;    96 | #include &lt;complex&gt;</span></span>
<span><span class="co">#&gt;       |          ^~~~~~~~~</span></span>
<span><span class="co">#&gt; compilation terminated.</span></span>
<span><span class="co">#&gt; make: *** [/usr/lib/R/etc/Makeconf:168: foo.o] Error 1</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Inferences</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_hier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sm_hier</span>,</span>
<span>                data <span class="op">=</span> <span class="va">SRSalmon</span>, </span>
<span>                pars <span class="op">=</span> <span class="cn">NA</span>, <span class="co">#params,</span></span>
<span>                chains <span class="op">=</span> <span class="va">n_chains</span>,</span>
<span>                <span class="co"># init = lapply(seq(4), function(x)</span></span>
<span>                <span class="co">#   list(alpha = 0, beta = 0)),</span></span>
<span>                iter <span class="op">=</span> <span class="fl">5000</span>, </span>
<span>                warmup <span class="op">=</span> <span class="fl">2500</span>, </span>
<span>                thin <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"adapt_delta"</span><span class="op">=</span> <span class="fl">.9</span><span class="op">)</span><span class="co">#list("max_treedepth" = 12)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There were 9 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre></div>
<p>Diagnostic of the convergence:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Sopt"</span>,<span class="st">"hopt"</span>,<span class="st">"tau"</span>, <span class="st">"delta"</span>, <span class="st">"kappa"</span>, <span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"CV_S"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_plot_diagnostics.html" class="external-link">stan_rhat</a></span><span class="op">(</span><span class="va">fit_hier</span><span class="op">)</span></span>
<span><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span></code></pre></div>
<p><img src="hierarchical-stock-recruitment_files/figure-html/hier-diagnostic-1.png" width="700"></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/rstan/reference/monitor.html" class="external-link">monitor</a></span><span class="op">(</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit_hier</span>, pars <span class="op">=</span> <span class="va">params</span>, permuted <span class="op">=</span> <span class="cn">FALSE</span>, inc_warmup <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for the input samples (4 chains: each with iter = 5000; warmup = 2500):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;             Q5  Q50  Q95 Mean   SD  Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; Sopt[1]    0.2  0.5  0.6  0.5  0.1     1     4256     2935</span></span>
<span><span class="co">#&gt; Sopt[2]    0.6  1.2  1.8  1.2  0.4     1     4341     4047</span></span>
<span><span class="co">#&gt; Sopt[3]    2.1  2.6  3.3  2.6  0.4     1     5804     4068</span></span>
<span><span class="co">#&gt; Sopt[4]    1.1  1.5  3.3  1.7  1.0     1     5180     3944</span></span>
<span><span class="co">#&gt; Sopt[5]    3.3  5.2 10.5  5.9  3.0     1     5419     4681</span></span>
<span><span class="co">#&gt; Sopt[6]    1.2  3.0  9.3  3.9  3.1     1     5324     6395</span></span>
<span><span class="co">#&gt; Sopt[7]    2.1  3.3  7.3  3.8  2.5     1     5063     4112</span></span>
<span><span class="co">#&gt; Sopt[8]    0.9  1.2  2.7  1.5  0.8     1     4747     3120</span></span>
<span><span class="co">#&gt; Sopt[9]    6.1  7.7 10.7  8.0  1.5     1     5767     5021</span></span>
<span><span class="co">#&gt; Sopt[10]   2.5  3.4  7.2  4.0  2.1     1     5353     3511</span></span>
<span><span class="co">#&gt; Sopt[11]   5.8  8.3 16.6  9.4  4.2     1     5665     4375</span></span>
<span><span class="co">#&gt; Sopt[12]   4.5 13.2 47.6 18.2 17.3     1     4051     4738</span></span>
<span><span class="co">#&gt; Sopt[13]  17.2 30.9 93.0 39.7 27.5     1     3340     2917</span></span>
<span><span class="co">#&gt; hopt[1]    0.1  0.3  0.5  0.3  0.1     1     4185     3098</span></span>
<span><span class="co">#&gt; hopt[2]    0.1  0.2  0.3  0.2  0.1     1     4284     4059</span></span>
<span><span class="co">#&gt; hopt[3]    0.2  0.4  0.6  0.4  0.1     1     6830     3991</span></span>
<span><span class="co">#&gt; hopt[4]    0.3  0.5  0.7  0.5  0.1     1     5432     5198</span></span>
<span><span class="co">#&gt; hopt[5]    0.5  0.7  0.8  0.7  0.1     1     5973     6012</span></span>
<span><span class="co">#&gt; hopt[6]    0.3  0.4  0.7  0.5  0.1     1     5260     5835</span></span>
<span><span class="co">#&gt; hopt[7]    0.6  0.7  0.8  0.7  0.1     1     5217     5781</span></span>
<span><span class="co">#&gt; hopt[8]    0.6  0.7  0.8  0.7  0.1     1     5035     3944</span></span>
<span><span class="co">#&gt; hopt[9]    0.7  0.8  0.9  0.8  0.0     1     5761     6107</span></span>
<span><span class="co">#&gt; hopt[10]   0.4  0.5  0.7  0.5  0.1     1     5354     4506</span></span>
<span><span class="co">#&gt; hopt[11]   0.2  0.5  0.8  0.5  0.2     1     4564     4443</span></span>
<span><span class="co">#&gt; hopt[12]   0.4  0.5  0.7  0.5  0.1     1     5287     5337</span></span>
<span><span class="co">#&gt; hopt[13]   0.5  0.7  0.9  0.7  0.1     1     3763     5070</span></span>
<span><span class="co">#&gt; tau        3.4  4.3  5.4  4.4  0.6     1     6141     6228</span></span>
<span><span class="co">#&gt; delta      0.0  0.1  0.2  0.1  0.1     1     4251     4231</span></span>
<span><span class="co">#&gt; kappa    -12.0 -5.7 -0.3 -5.8  3.7     1     4239     4093</span></span>
<span><span class="co">#&gt; alpha      0.1  0.2  0.3  0.2  0.0     1     3099     3126</span></span>
<span><span class="co">#&gt; beta     -14.2 -9.5 -5.6 -9.7  2.7     1     3180     3281</span></span>
<span><span class="co">#&gt; CV_S       0.4  0.6  1.0  0.6  0.2     1     3842     4560</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; For each parameter, Bulk_ESS and Tail_ESS are crude measures of </span></span>
<span><span class="co">#&gt; effective sample size for bulk and tail quantities respectively (an ESS &gt; 100 </span></span>
<span><span class="co">#&gt; per chain is considered good), and Rhat is the potential scale reduction </span></span>
<span><span class="co">#&gt; factor on rank normalized split chains (at convergence, Rhat &lt;= 1.05).</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit_hier</span>, par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lp__"</span>, <span class="va">params</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: HSR_Ricker_LogN_Management_S_gamma_hier.</span></span>
<span><span class="co">#&gt; 4 chains, each with iter=5000; warmup=2500; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=2500, total post-warmup draws=10000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean    sd   2.5%    25%   50%   75%  97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; lp__     21.89    0.13  5.62   9.58  18.39 22.47 25.90  31.36  2020    1</span></span>
<span><span class="co">#&gt; Sopt[1]   0.45    0.00  0.13   0.16   0.37  0.47  0.55   0.67  3742    1</span></span>
<span><span class="co">#&gt; Sopt[2]   1.20    0.01  0.38   0.45   0.93  1.21  1.47   1.93  4315    1</span></span>
<span><span class="co">#&gt; Sopt[3]   2.62    0.01  0.40   1.93   2.38  2.59  2.83   3.49  4812    1</span></span>
<span><span class="co">#&gt; Sopt[4]   1.74    0.02  0.96   1.01   1.25  1.46  1.86   4.23  3203    1</span></span>
<span><span class="co">#&gt; Sopt[5]   5.86    0.05  2.95   3.09   4.20  5.18  6.65  12.58  3727    1</span></span>
<span><span class="co">#&gt; Sopt[6]   3.88    0.04  3.13   1.11   1.95  3.01  4.80  11.69  4963    1</span></span>
<span><span class="co">#&gt; Sopt[7]   3.85    0.05  2.50   2.01   2.68  3.30  4.25   8.98  3003    1</span></span>
<span><span class="co">#&gt; Sopt[8]   1.45    0.02  0.84   0.86   1.06  1.24  1.53   3.57  2584    1</span></span>
<span><span class="co">#&gt; Sopt[9]   8.01    0.02  1.53   5.91   7.00  7.74  8.70  11.57  4603    1</span></span>
<span><span class="co">#&gt; Sopt[10]  3.99    0.04  2.13   2.40   2.96  3.44  4.26   8.95  2344    1</span></span>
<span><span class="co">#&gt; Sopt[11]  9.41    0.07  4.20   5.48   7.03  8.30 10.39  20.41  3645    1</span></span>
<span><span class="co">#&gt; Sopt[12] 18.21    0.30 17.26   3.88   8.04 13.15 21.93  64.00  3370    1</span></span>
<span><span class="co">#&gt; Sopt[13] 39.72    0.56 27.51  15.77  23.28 30.95 45.02 123.13  2383    1</span></span>
<span><span class="co">#&gt; hopt[1]   0.26    0.00  0.12   0.05   0.17  0.25  0.34   0.50  4639    1</span></span>
<span><span class="co">#&gt; hopt[2]   0.17    0.00  0.07   0.05   0.12  0.16  0.22   0.33  4750    1</span></span>
<span><span class="co">#&gt; hopt[3]   0.42    0.00  0.11   0.19   0.35  0.43  0.49   0.61  6030    1</span></span>
<span><span class="co">#&gt; hopt[4]   0.53    0.00  0.13   0.27   0.45  0.54  0.62   0.75  4901    1</span></span>
<span><span class="co">#&gt; hopt[5]   0.68    0.00  0.09   0.50   0.62  0.68  0.74   0.85  5926    1</span></span>
<span><span class="co">#&gt; hopt[6]   0.46    0.00  0.13   0.24   0.37  0.45  0.54   0.74  5089    1</span></span>
<span><span class="co">#&gt; hopt[7]   0.72    0.00  0.07   0.59   0.68  0.72  0.77   0.84  4989    1</span></span>
<span><span class="co">#&gt; hopt[8]   0.74    0.00  0.06   0.59   0.70  0.75  0.79   0.84  4235    1</span></span>
<span><span class="co">#&gt; hopt[9]   0.81    0.00  0.05   0.71   0.79  0.82  0.85   0.89  5271    1</span></span>
<span><span class="co">#&gt; hopt[10]  0.52    0.00  0.09   0.32   0.46  0.52  0.58   0.68  4813    1</span></span>
<span><span class="co">#&gt; hopt[11]  0.51    0.00  0.17   0.16   0.39  0.52  0.64   0.81  4313    1</span></span>
<span><span class="co">#&gt; hopt[12]  0.52    0.00  0.09   0.36   0.46  0.51  0.57   0.72  5058    1</span></span>
<span><span class="co">#&gt; hopt[13]  0.71    0.00  0.10   0.52   0.64  0.71  0.78   0.89  3711    1</span></span>
<span><span class="co">#&gt; tau       4.37    0.01  0.61   3.24   3.94  4.35  4.75   5.63  6237    1</span></span>
<span><span class="co">#&gt; delta     0.11    0.00  0.07  -0.02   0.07  0.11  0.15   0.25  4092    1</span></span>
<span><span class="co">#&gt; kappa    -5.85    0.06  3.65 -13.48  -8.06 -5.70 -3.49   1.00  4077    1</span></span>
<span><span class="co">#&gt; alpha     0.21    0.00  0.05   0.11   0.17  0.20  0.23   0.31  2907    1</span></span>
<span><span class="co">#&gt; beta     -9.69    0.05  2.67 -15.39 -11.26 -9.53 -7.94  -4.82  2993    1</span></span>
<span><span class="co">#&gt; CV_S      0.65    0.00  0.18   0.37   0.52  0.62  0.75   1.07  3944    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Mon Aug 29 19:57:34 2022.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span></code></pre></div>
<p>The few divergent transitions does not seem to have any particular
shape.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pairs_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">SRSalmon</span><span class="op">$</span><span class="va">n_riv</span><span class="op">)</span>,</span>
<span>       <span class="kw">function</span><span class="op">(</span><span class="va">k</span><span class="op">)</span>  <span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html" class="external-link">pairs</a></span><span class="op">(</span><span class="va">fit_hier</span>, </span>
<span>                          pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Sopt["</span>, <span class="va">k</span>, <span class="st">"]"</span><span class="op">)</span>, </span>
<span>                                   <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"hopt["</span>, <span class="va">k</span>, <span class="st">"]"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span>
<span></span>
<span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span></code></pre></div>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<pre><code><span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span>
<span></span>
<span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span></code></pre>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-14-2.png" width="700"></p>
<pre><code><span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span>
<span></span>
<span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span></code></pre>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-14-3.png" width="700"></p>
<pre><code><span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span>
<span></span>
<span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span></code></pre>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-14-4.png" width="700"></p>
<pre><code><span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span>
<span></span>
<span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span></code></pre>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-14-5.png" width="700"></p>
<pre><code><span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span>
<span></span>
<span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span></code></pre>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-14-6.png" width="700"></p>
<pre><code><span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span>
<span><span class="co">#&gt; Warning in KernSmooth::bkde2D(x, bandwidth = bandwidth, gridsize = nbin, :</span></span>
<span><span class="co">#&gt; Binning grid too coarse for current (small) bandwidth: consider increasing</span></span>
<span><span class="co">#&gt; 'gridsize'</span></span>
<span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span></code></pre>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-14-7.png" width="700"></p>
<pre><code><span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span>
<span></span>
<span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span></code></pre>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-14-8.png" width="700"></p>
<pre><code><span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span>
<span></span>
<span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span></code></pre>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-14-9.png" width="700"></p>
<pre><code><span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span>
<span></span>
<span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span></code></pre>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-14-10.png" width="700"></p>
<pre><code><span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span>
<span></span>
<span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span></code></pre>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-14-11.png" width="700"></p>
<pre><code><span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span>
<span></span>
<span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span></code></pre>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-14-12.png" width="700"></p>
<pre><code><span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span>
<span></span>
<span><span class="co">#&gt; Warning in par(usr): argument 1 does not name a graphical parameter</span></span></code></pre>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-14-13.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="results-and-analysis">Results and analysis<a class="anchor" aria-label="anchor" href="#results-and-analysis"></a>
</h2>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">names_ind</span> <span class="op">&lt;-</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">name_riv</span><span class="co">#c("Nivelle","Oir","Frome","Dee","Burrishoole","Lune","Bush",</span></span>
<span><span class="co">#"Mourne","Faughan","Girnock Burn","North Esk","Laerdalselva","Ellidaar")</span></span>
<span></span>
<span><span class="va">names_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Nivelle"</span>,<span class="st">"new 45?"</span>,<span class="st">"Oir"</span>,<span class="st">"new 50?"</span>,<span class="st">"Frome"</span>,<span class="st">"Dee"</span>,<span class="st">"Burrishoole"</span>,<span class="st">"Lune"</span>,<span class="st">"new 55?"</span>,<span class="st">"Bush"</span>,</span>
<span><span class="st">"Mourne"</span>,<span class="st">"Faughan"</span>,<span class="st">"Girnock Burn"</span>,<span class="st">"North Esk"</span>,<span class="st">"new 60?"</span>,<span class="st">"Laerdalselva"</span>,<span class="st">"Ellidaar"</span>,<span class="st">"new 65?"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dfw_hier</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_wider.html">extract_wider</a></span><span class="op">(</span><span class="va">fit_hier</span><span class="op">)</span></span>
<span><span class="va">dfl_hier</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_longer.html">extract_longer</a></span><span class="op">(</span><span class="va">fit_hier</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Model <span class="op">=</span> <span class="st">"Hierarchical"</span><span class="op">)</span></span></code></pre></div>
<p>Plotting Figure 9., Page 210</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Sopt_hier</span> <span class="op">&lt;-</span> <span class="va">dfl_hier</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="st">"Sopt\\."</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Site <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">as_factor</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"Sopt."</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Site</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>Sopt_med <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Sopt_med</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/as_vector.html" class="external-link">as_vector</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hopt_hier</span> <span class="op">&lt;-</span> <span class="va">fit_hier</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/extract_longer.html">extract_longer</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="st">"hopt\\."</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Site <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">as_factor</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"hopt."</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Site</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>hopt_med <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">hopt_med</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/as_vector.html" class="external-link">as_vector</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Sopt_ind</span> <span class="op">&lt;-</span> <span class="va">dfl_gamma</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="st">"Sopt\\."</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Site <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">as_factor</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"Sopt."</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Site</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>Sopt_med <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Sopt_med</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/as_vector.html" class="external-link">as_vector</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hopt_ind</span> <span class="op">&lt;-</span> <span class="va">dfl_gamma</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="st">"hopt\\."</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Site <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">as_factor</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"hopt."</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Site</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>Sopt_med <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Sopt_med</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/as_vector.html" class="external-link">as_vector</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">max_S</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">Sopt_ind</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">SRSalmon</span><span class="op">$</span><span class="va">S</span><span class="op">[</span><span class="va">SRSalmon</span><span class="op">$</span><span class="va">riv</span> <span class="op">==</span> <span class="va">k</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Splot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">100</span>,length.out<span class="op">=</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">Rplot_ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">Sopt_ind</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>S <span class="op">=</span> <span class="va">Splot</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fl">15</span><span class="op">*</span><span class="va">max_S</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span><span class="op">]</span>,</span>
<span>           river <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">as_factor</a></span><span class="op">(</span><span class="va">names_ind</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span>,</span>
<span>           R <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">Splot</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fl">15</span><span class="op">*</span><span class="va">max_S</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="va">hopt_ind</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">-</span> </span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">hopt_ind</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">hopt_ind</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">/</span><span class="va">Sopt_ind</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="va">Splot</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fl">15</span><span class="op">*</span><span class="va">max_S</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span><span class="op">]</span> <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Rplot_hier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">Sopt_hier</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>S <span class="op">=</span> <span class="va">Splot</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fl">15</span><span class="op">*</span><span class="va">max_S</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span><span class="op">]</span>,</span>
<span>           river <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">as_factor</a></span><span class="op">(</span><span class="va">names_ind</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span>,</span>
<span>           R <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">Splot</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fl">15</span><span class="op">*</span><span class="va">max_S</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="va">hopt_hier</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">-</span> </span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">hopt_hier</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">hopt_hier</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">/</span><span class="va">Sopt_hier</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="va">Splot</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fl">15</span><span class="op">*</span><span class="va">max_S</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span><span class="op">]</span> <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>R <span class="op">=</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">R</span>, S <span class="op">=</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">S</span>, </span>
<span>       river <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">names_ind</span><span class="op">[</span><span class="va">SRSalmon</span><span class="op">$</span><span class="va">riv</span><span class="op">]</span>, levels <span class="op">=</span> <span class="va">names_ind</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">S</span>, y <span class="op">=</span> <span class="va">R</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">river</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">Rplot_hier</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">Rplot_ind</span>, size <span class="op">=</span> <span class="fl">1</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">plot_theme</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dfl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">dfl_gamma</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Model <span class="op">=</span> <span class="st">"Independent"</span><span class="op">)</span>, <span class="va">dfl_hier</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dfl</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="st">"Sopt\\."</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="st">"S*"</span> <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Site <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">as_factor</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"Sopt."</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Site</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">`S*`</span><span class="op">)</span>, fill <span class="op">=</span> <span class="va">Model</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>outlier.shape <span class="op">=</span> <span class="cn">NA</span>, outlier.size <span class="op">=</span> <span class="fl">.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_x_discrete</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">names_ind</span>, guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_axis.html" class="external-link">guide_axis</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>,<span class="fl">6</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gray50"</span>, <span class="st">"gray90"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"log(S*)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">plot_theme</span></span>
<span><span class="co">#&gt; Warning: Removed 47 rows containing non-finite values (stat_boxplot).</span></span></code></pre></div>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-24-1.png" width="700"></p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dfl</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="st">"hopt\\."</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="st">"h*"</span> <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Site <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">as_factor</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"hopt."</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Site</span>, fill <span class="op">=</span> <span class="va">Model</span>, y <span class="op">=</span> <span class="va">`h*`</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>outlier.shape <span class="op">=</span> <span class="cn">NA</span>,outlier.size <span class="op">=</span> <span class="fl">.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_x_discrete</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">names_ind</span>, guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_axis.html" class="external-link">guide_axis</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gray50"</span>, <span class="st">"gray90"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="va">plot_theme</span></span></code></pre></div>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-25-1.png" width="700"></p>
<p>Plotting marginal posterior probability shapes of the parameters
<span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span>, <span class="math inline">\(\delta\)</span>, <span class="math inline">\(\kappa\)</span>, <span class="math inline">\(\sigma\)</span>, <span class="math inline">\(\tau_{h*}\)</span> (Fig. 9.12 page 216)</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dfl_hier</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">parameter</span>  <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"delta"</span>, <span class="st">"kappa"</span>, <span class="st">"sigma"</span>, <span class="st">"sigma_h"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/replace.html" class="external-link">replace</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="va">parameter</span> <span class="op">==</span> <span class="st">"sigma_h"</span>, <span class="st">"sigma[h]"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span>adjust <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">parameter</span>, ncol <span class="op">=</span> <span class="fl">2</span>, scales <span class="op">=</span> <span class="st">"free"</span>, labeller <span class="op">=</span> <span class="va">label_parsed</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">plot_theme</span></span></code></pre></div>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-26-1.png" width="700"></p>
<p>Marginal posterior distributions and posterior predictive of <span class="math inline">\(\log(S*)\)</span> for the hierarchical model
(fig. 9.13 page 217)</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reg_param</span> <span class="op">&lt;-</span> <span class="va">dfw_hier</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">alpha</span>, <span class="va">beta</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>med_a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">alpha</span><span class="op">)</span>, med_b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_data</span> <span class="op">&lt;-</span> <span class="va">dfl_hier</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="st">"Sopt\\."</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="st">"S*"</span> <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"Sopt."</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Latitude <span class="op">=</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">lat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"Sopt."</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,</span>
<span>         type <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">fit_pred</span> <span class="op">&lt;-</span> <span class="va">dfl_hier</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="st">"Sopt_"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="st">"S*"</span> <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"Sopt_"</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Latitude <span class="op">=</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">lat_pred</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>,<span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"Sopt_pred."</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,</span>
<span>         type <span class="op">=</span> <span class="st">"pred"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">fit_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">fit_pred</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Latitude</span>, group <span class="op">=</span> <span class="va">id</span>,  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">`S*`</span><span class="op">)</span>, fill <span class="op">=</span> <span class="va">type</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>outlier.shape <span class="op">=</span> <span class="cn">NA</span>,outlier.size <span class="op">=</span> <span class="fl">.25</span>, varwidth <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="co">#  scale_x_discrete(labels = names_ind, guide = guide_axis(angle = 90)) +</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gray90"</span>, <span class="st">"gray50"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>slope <span class="op">=</span> <span class="va">reg_param</span><span class="op">$</span><span class="va">med_a</span>, intercept <span class="op">=</span> <span class="va">reg_param</span><span class="op">$</span><span class="va">med_b</span><span class="op">)</span> <span class="op">+</span> <span class="co">#-reg_param$med_a*mean(data_hier$lat)) +</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"log(S*)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">plot_theme</span></span>
<span><span class="co">#&gt; Warning: Removed 1184 rows containing non-finite values (stat_boxplot).</span></span></code></pre></div>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-27-1.png" width="700"></p>
<p>Marginal posterior distributions and posterior predictive of <span class="math inline">\(h*\)</span> for the hierarchical model (fig. 9.14
page 218)</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reg_param</span> <span class="op">&lt;-</span> <span class="va">dfw_hier</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">delta</span>, <span class="va">kappa</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>med_d <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">delta</span><span class="op">)</span>, med_k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">kappa</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_data</span> <span class="op">&lt;-</span> <span class="va">dfl_hier</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="st">"^hopt\\."</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># detect hopt. without logit_hopt.</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="st">"h*"</span> <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"hopt."</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Latitude <span class="op">=</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">lat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"hopt."</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,</span>
<span>         type <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">fit_pred</span> <span class="op">&lt;-</span> <span class="va">dfl_hier</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="st">"^hopt_"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="st">"h*"</span> <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"hopt_"</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Latitude <span class="op">=</span> <span class="va">SRSalmon</span><span class="op">$</span><span class="va">lat_pred</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">parameter</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_length.html" class="external-link">str_length</a></span><span class="op">(</span><span class="st">"hopt_pred."</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,</span>
<span>         type <span class="op">=</span> <span class="st">"pred"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">fit_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">fit_pred</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Latitude</span>, group <span class="op">=</span> <span class="va">id</span>,  y <span class="op">=</span> <span class="va">`h*`</span>, fill <span class="op">=</span> <span class="va">type</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>outlier.shape <span class="op">=</span> <span class="cn">NA</span>,outlier.size <span class="op">=</span> <span class="fl">.25</span>, varwidth <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="co">#  scale_x_discrete(labels = names_ind, guide = guide_axis(angle = 90)) +</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gray90"</span>, <span class="st">"gray50"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">42</span>, <span class="fl">65</span>, <span class="fl">.1</span><span class="op">)</span>, </span>
<span>           y <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">reg_param</span><span class="op">$</span><span class="va">med_d</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">42</span>, <span class="fl">65</span>, <span class="fl">.1</span><span class="op">)</span> <span class="op">-</span><span class="va">reg_param</span><span class="op">$</span><span class="va">med_k</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           geom <span class="op">=</span> <span class="st">"line"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">plot_theme</span></span></code></pre></div>
<p><img src="hierarchical-stock-recruitment_files/figure-html/unnamed-chunk-28-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Crozier2003" class="csl-entry">
Crozier, W. W., E. C. E. Potter, E. Prévost, P.-J. Schön, and O.
Maoiléidigh. 2003. <span>“A Coordinated Approach Towards the Development
of a Scientific Basis for Management of Wild <span>A</span>tlantic
Salmon in the <span>N</span>orth-<span>E</span>ast
<span>A</span>tlantic.”</span> Concerted Action QLK5-CT1999e01546
(SALMODEL).
</div>
<div id="ref-PrevostChaput2001" class="csl-entry">
Prévost, E., G. Chaput, and (Ed.). 2001. <em>Stock, Recruitment and
Reference Points Assessment and Management of <span>A</span>tlantic
Salmon</em>. INRA Editions, Paris.
</div>
<div id="ref-Prevost2003" class="csl-entry">
Prévost, E., E. Parent, W. Crozier, I. Davidson, J. Dumas, G.
Gudbergsson, K. Hindar, P. McGinnity, J. MacLean, and L. M. Sattem.
2003. <span>“Setting Biological Reference Points for
<span>A</span>tlantic Salmon Stocks: Transfer of Information from
Data-Rich to Sparse-Data Situations by <span>B</span>ayesian
Hierarchical Modelling.”</span> <em>ICES Journal of Marine Science</em>
60: 1177–93.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Saint-Clair Chabert-Liddell, Éric Parent, Étienne Rivot.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
